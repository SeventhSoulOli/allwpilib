From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Kevin O'Connor <koconnor@usfirst.org>
Date: Fri, 21 Nov 2014 10:37:29 -0500
Subject: [PATCH 0499/6262] Get MatchTime from NetComms (fixes artf2538)

Change-Id: I7ea438ce4610087bceac696a958e3c1e3ead238a
---
 hal/include/HAL/HAL.hpp                            |  1 +
 hal/lib/Athena/HAL.cpp                             |  5 +++++
 wpilibc/wpilibC++Devices/src/DriverStation.cpp     |  6 +++---
 .../java/edu/wpi/first/wpilibj/DriverStation.java  |  5 +----
 .../FRCNetworkCommunicationsLibrary.java           |  1 +
 .../lib/FRCNetworkCommunicationsLibrary.cpp        | 14 ++++++++++++++
 6 files changed, 25 insertions(+), 7 deletions(-)

diff --git a/hal/include/HAL/HAL.hpp b/hal/include/HAL/HAL.hpp
index 187703bc883db72a1a33b44f51df16022f2090fb..8fdf7162e0e288acc2f03bdfbe453be6fbc46f86 100644
--- a/hal/include/HAL/HAL.hpp
+++ b/hal/include/HAL/HAL.hpp
@@ -214,6 +214,7 @@ extern "C"
 	int HALGetJoystickAxes(uint8_t joystickNum, HALJoystickAxes *axes);
 	int HALGetJoystickPOVs(uint8_t joystickNum, HALJoystickPOVs *povs);
 	int HALGetJoystickButtons(uint8_t joystickNum, HALJoystickButtons *buttons, uint8_t *count);
+	int HALGetMatchTime(float *matchTime);
 
 	void HALSetNewDataSem(pthread_cond_t *);
 	
diff --git a/hal/lib/Athena/HAL.cpp b/hal/lib/Athena/HAL.cpp
index 1526467e1c2d8862414b9eb37310613fb723a178..726edf1fc8a19ae97240f38a5171f585fa64365e 100644
--- a/hal/lib/Athena/HAL.cpp
+++ b/hal/lib/Athena/HAL.cpp
@@ -206,6 +206,11 @@ int HALGetJoystickButtons(uint8_t joystickNum, HALJoystickButtons *buttons, uint
 	return FRC_NetworkCommunication_getJoystickButtons(joystickNum, buttons, count);
 }
 
+int HALGetMatchTime(float *matchTime)
+{
+	return FRC_NetworkCommunication_getMatchTime(matchTime);
+}
+
 void HALSetNewDataSem(pthread_cond_t * param)
 {
 	setNewDataSem(param);
diff --git a/wpilibc/wpilibC++Devices/src/DriverStation.cpp b/wpilibc/wpilibC++Devices/src/DriverStation.cpp
index 1de5d825ea6b38361a856e103d67107196c5505b..64c13b6c51303b1f6f1d1695c7c9213840a93b7a 100644
--- a/wpilibc/wpilibC++Devices/src/DriverStation.cpp
+++ b/wpilibc/wpilibC++Devices/src/DriverStation.cpp
@@ -397,9 +397,9 @@ void DriverStation::WaitForData()
  */
 double DriverStation::GetMatchTime()
 {
-	if (m_approxMatchTimeOffset < 0.0)
-		return 0.0;
-	return Timer::GetFPGATimestamp() - m_approxMatchTimeOffset;
+	float matchTime;
+	HALGetMatchTime(&matchTime);
+	return (double)matchTime;
 }
 
 /**
diff --git a/wpilibj/wpilibJavaDevices/src/main/java/edu/wpi/first/wpilibj/DriverStation.java b/wpilibj/wpilibJavaDevices/src/main/java/edu/wpi/first/wpilibj/DriverStation.java
index 5cbef1c8b3c80ba4c2d6901b37c901c2e0f774b1..4094110651855bbd99a529e5db88b7ece0a1e0b8 100644
--- a/wpilibj/wpilibJavaDevices/src/main/java/edu/wpi/first/wpilibj/DriverStation.java
+++ b/wpilibj/wpilibJavaDevices/src/main/java/edu/wpi/first/wpilibj/DriverStation.java
@@ -433,10 +433,7 @@ public class DriverStation implements RobotState.Interface {
      * @return Match time in seconds since the beginning of autonomous
      */
     public double getMatchTime() {
-        if (m_approxMatchTimeOffset < 0.0) {
-            return 0.0;
-        }
-        return Timer.getFPGATimestamp() - m_approxMatchTimeOffset;
+        return FRCNetworkCommunicationsLibrary.HALGetMatchTime();
     }
 	
 	/**
diff --git a/wpilibj/wpilibJavaDevices/src/main/java/edu/wpi/first/wpilibj/communication/FRCNetworkCommunicationsLibrary.java b/wpilibj/wpilibJavaDevices/src/main/java/edu/wpi/first/wpilibj/communication/FRCNetworkCommunicationsLibrary.java
index 323b3fe22dae90ee1880fe1ec6e9657d35a0bdc4..01d7c069fcdf6fcde99e8c0736a1e4121fb89d03 100644
--- a/wpilibj/wpilibJavaDevices/src/main/java/edu/wpi/first/wpilibj/communication/FRCNetworkCommunicationsLibrary.java
+++ b/wpilibj/wpilibJavaDevices/src/main/java/edu/wpi/first/wpilibj/communication/FRCNetworkCommunicationsLibrary.java
@@ -468,6 +468,7 @@ public class FRCNetworkCommunicationsLibrary extends JNIWrapper {
 	public static native short[] HALGetJoystickAxes(byte joystickNum);
 	public static native short[] HALGetJoystickPOVs(byte joystickNum);
 	public static native int HALGetJoystickButtons(byte joystickNum);
+	public static native float HALGetMatchTime();
 	public static native boolean HALGetSystemActive(IntBuffer status);
 	public static native boolean HALGetBrownedOut(IntBuffer status);
 	
diff --git a/wpilibj/wpilibJavaJNI/lib/FRCNetworkCommunicationsLibrary.cpp b/wpilibj/wpilibJavaJNI/lib/FRCNetworkCommunicationsLibrary.cpp
index aed1299364743f5dab837ce057fd776bd3e469be..9d15fba780123d2484c0835f2c6909b35c6590af 100644
--- a/wpilibj/wpilibJavaJNI/lib/FRCNetworkCommunicationsLibrary.cpp
+++ b/wpilibj/wpilibJavaJNI/lib/FRCNetworkCommunicationsLibrary.cpp
@@ -535,6 +535,20 @@ JNIEXPORT jobject JNICALL Java_edu_wpi_first_wpilibj_communication_FRCNetworkCom
 	return env->NewDirectByteBuffer(returnByteArray, 4);
 }
 
+/*
+ * Class:     edu_wpi_first_wpilibj_communication_FRCNetworkCommunicationsLibrary
+
+ * Method:    HALGetMatchTime
+ * Signature: ()F
+ */
+JNIEXPORT jfloat JNICALL Java_edu_wpi_first_wpilibj_communication_FRCNetworkCommunicationsLibrary_HALGetMatchTime
+  (JNIEnv * env, jclass)
+{
+	jfloat matchTime;
+	HALGetMatchTime((float*)&matchTime);
+	return matchTime;
+}
+
 /*
  * Class:     edu_wpi_first_wpilibj_communication_FRCNetworkCommunicationsLibrary
  * Method:    HALGetSystemActive
