From de99e28908332bc5dc5105a99e63114d3d420caf Mon Sep 17 00:00:00 2001
From: PJ Reiniger <pj.reiniger@gmail.com>
Date: Wed, 4 May 2022 01:15:57 -0400
Subject: [PATCH 21/36] Something Something Something

---
 llvm/lib/Support/ErrorHandling.cpp |  7 +------
 llvm/lib/Support/raw_ostream.cpp   | 10 ++++------
 2 files changed, 5 insertions(+), 12 deletions(-)

diff --git a/llvm/lib/Support/ErrorHandling.cpp b/llvm/lib/Support/ErrorHandling.cpp
index c4b9c67c99e7..3f43db159175 100644
--- a/llvm/lib/Support/ErrorHandling.cpp
+++ b/llvm/lib/Support/ErrorHandling.cpp
@@ -97,12 +97,7 @@ void llvm::report_fatal_error(const std::string_view &Reason, bool GenCrashDiag)
     fmt::print(stderr, "LLVM ERROR: {}\n", Reason);
   }
 
-  // If we reached here, we are failing ungracefully. Run the interrupt handlers
-  // to make sure any special cleanups get done, in particular that we remove
-  // files registered with RemoveFileOnSignal.
-  sys::RunInterruptHandlers();
-
-  sys::Process::Exit(1);
+  exit(1);
 }
 
 void llvm::install_bad_alloc_error_handler(fatal_error_handler_t handler,
diff --git a/llvm/lib/Support/raw_ostream.cpp b/llvm/lib/Support/raw_ostream.cpp
index 5fc0db039c29..4cace846e000 100644
--- a/llvm/lib/Support/raw_ostream.cpp
+++ b/llvm/lib/Support/raw_ostream.cpp
@@ -387,10 +387,8 @@ raw_fd_ostream::raw_fd_ostream(int fd, bool shouldClose, bool unbuffered)
 raw_fd_ostream::~raw_fd_ostream() {
   if (FD >= 0) {
     flush();
-    if (ShouldClose) {
-      if (auto EC = sys::Process::SafelyCloseFileDescriptor(FD))
-        error_detected(EC);
-    }
+    if (ShouldClose && ::close(FD) < 0)
+      error_detected(std::error_code(errno, std::generic_category()));
   }
 
 #ifdef __MINGW32__
@@ -520,8 +518,8 @@ void raw_fd_ostream::close() {
   assert(ShouldClose);
   ShouldClose = false;
   flush();
-  if (auto EC = sys::Process::SafelyCloseFileDescriptor(FD))
-    error_detected(EC);
+  if (::close(FD) < 0)
+    error_detected(std::error_code(errno, std::generic_category()));
   FD = -1;
 }
 
-- 
2.20.1.windows.1

