From e2d5b6e02f3139641c166213d83b0b192be252dd Mon Sep 17 00:00:00 2001
From: PJ Reiniger <pj.reiniger@gmail.com>
Date: Wed, 4 May 2022 01:15:57 -0400
Subject: [PATCH 21/36] Something Something Something

---
 llvm/lib/Support/ErrorHandling.cpp |  5 -----
 llvm/lib/Support/raw_ostream.cpp   | 10 ++++------
 2 files changed, 4 insertions(+), 11 deletions(-)

diff --git a/llvm/lib/Support/ErrorHandling.cpp b/llvm/lib/Support/ErrorHandling.cpp
index c7dd696b7288..ca76a8368520 100644
--- a/llvm/lib/Support/ErrorHandling.cpp
+++ b/llvm/lib/Support/ErrorHandling.cpp
@@ -96,11 +96,6 @@ void llvm::report_fatal_error(const std::string_view &Reason, bool GenCrashDiag)
     fmt::print(stderr, "LLVM ERROR: {}\n", Reason);
   }
 
-  // If we reached here, we are failing ungracefully. Run the interrupt handlers
-  // to make sure any special cleanups get done, in particular that we remove
-  // files registered with RemoveFileOnSignal.
-  sys::RunInterruptHandlers();
-
   exit(1);
 }
 
diff --git a/llvm/lib/Support/raw_ostream.cpp b/llvm/lib/Support/raw_ostream.cpp
index e58d5196dfb3..2659d50137b1 100644
--- a/llvm/lib/Support/raw_ostream.cpp
+++ b/llvm/lib/Support/raw_ostream.cpp
@@ -376,10 +376,8 @@ raw_fd_ostream::raw_fd_ostream(int fd, bool shouldClose, bool unbuffered)
 raw_fd_ostream::~raw_fd_ostream() {
   if (FD >= 0) {
     flush();
-    if (ShouldClose) {
-      if (auto EC = sys::Process::SafelyCloseFileDescriptor(FD))
-        error_detected(EC);
-    }
+    if (ShouldClose && ::close(FD) < 0)
+      error_detected(std::error_code(errno, std::generic_category()));
   }
 
 #ifdef __MINGW32__
@@ -509,8 +507,8 @@ void raw_fd_ostream::close() {
   assert(ShouldClose);
   ShouldClose = false;
   flush();
-  if (auto EC = sys::Process::SafelyCloseFileDescriptor(FD))
-    error_detected(EC);
+  if (::close(FD) < 0)
+    error_detected(std::error_code(errno, std::generic_category()));
   FD = -1;
 }
 
-- 
2.20.1.windows.1

