# Job for building

parameters:
  jobName: ''
  pool:
    vmImage: 'Ubuntu 16.04'
  container: wpilib2020
  preBuild: []
  gradleOptions: ''
  jdkVersionOption: ''
  buildOptions: ''
  artifactName: ''

jobs:
- job: ${{ parameters.jobName }}
  pool: ${{ parameters.pool }}

  ${{ if ne(parameters.container, '') }}:
    container: ${{ parameters.container }}

  workspace:
    clean: all

  timeoutInMinutes: 0

  steps:
    - ${{ parameters.preBuild }}

# PR Builds
    - ${{ if not(startsWith(variables['Build.SourceBranch'], 'refs/tags/v')) }}:
      - task: Gradle@2
        inputs:
          workingDirectory: ''
          gradleWrapperFile: 'gradlew'
          gradleOptions: '-Xmx3072m ${{ parameters.gradleOptions }}'
          ${{ if ne(parameters.jdkVersionOption, '') }}:
            jdkVersionOption: ${{ parameters.jdkVersionOption }}
          publishJUnitResults: true
          testResultsFiles: '**/TEST-*.xml'
          tasks: ':wpiutil:test'
          options: '-PbuildServer --info ${{ parameters.buildOptions }}'

# Tagged Builds
    - ${{ if startsWith(variables['Build.SourceBranch'], 'refs/tags/v') }}:
      - task: Gradle@2
        inputs:
          workingDirectory: ''
          gradleWrapperFile: 'gradlew'
          gradleOptions: '-Xmx3072m ${{ parameters.gradleOptions }}'
          ${{ if ne(parameters.jdkVersionOption, '') }}:
            jdkVersionOption: ${{ parameters.jdkVersionOption }}
          publishJUnitResults: true
          testResultsFiles: '**/TEST-*.xml'
          tasks: 'build'
          options: '-PreleaseMode -PbuildServer ${{ parameters.buildOptions }}'

    - powershell: ls wpiutil\build\install\wpiutilDev\windowsx86-64\lib\
      condition: always()

    - script: |
        "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\gflags.exe" -i wpiutil\build\install\wpiutilDev\windowsx86-64\lib\wpiutilDev.exe +sls
        "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\gflags.exe" -i wpiutil\build\install\wpiutilDev\windowsx86-64\lib\wpiutiljni.dll +sls
        "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\cdb.exe" -g -G wpiutil\build\install\wpiutilDev\windowsx86-64\lib\wpiutilDev.exe
      condition: always()

    - script: |
        "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\gflags.exe" -i wpiutil\build\install\wpiutilDev\windowsx86-64\lib\wpiutilDev.exe +sls
        "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\gflags.exe" -i wpiutil\build\install\wpiutilDev\windowsx86-64\lib\wpiutiljni.dll +sls
        "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\gflags.exe" -i "C:\Program Files\Java\zulu-11-azure-jdk_11.33.15-11.0.4-win_x64\bin\java.exe" +sls
        copy Program.java wpiutil\build\install\wpiutilDev\windowsx86-64\lib\Program.java
        cd wpiutil\build\install\wpiutilDev\windowsx86-64\lib

        "C:\Program Files\Java\zulu-11-azure-jdk_11.33.15-11.0.4-win_x64\bin\javac.exe" Program.java

        SET PATH="C:\Program Files\Java\zulu-11-azure-jdk_11.33.15-11.0.4-win_x64\bin\"
        "C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\cdb.exe" -g -G -x "C:\Program Files\Java\zulu-11-azure-jdk_11.33.15-11.0.4-win_x64\bin\java.exe" "-Djava.library.path=." Program
      condition: always()

    - task: PublishPipelineArtifact@0
      condition: always()
      inputs:
        artifactName: ${{ parameters.artifactName }}
        targetPath: 'wpiutil\build\install\wpiutilDev\windowsx86-64\lib\'
